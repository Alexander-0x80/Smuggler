#!/usr/bin/env python

import os
import sys
from slimit import minify

# Lookup table
symbols = {
    'a': '((!!+[]+"")[+!![]])',
    'b': '((({})+"")[(+!![])+(+!![])])',
    'c': '((({})+"")[(+!![])+(+!![])+(+!![])+(+!![])+(+!![])])',
    'd': '((({})[""]+"")[(+!![])+(+!![])])',
    'e': '((!!+[]+"")[(+!![])+(+!![])+(+!![])+(+!![])])',
    'f': '((!!+[]+"")[+[]])',
    'g': '"\\x67"',
    'h': '"\\x68"',
    'i': '((+!![]/+[]+"")[(+!![])+(+!![])+(+!![])])',
    'j': '((({})+"")[(+!![])+(+!![])+(+!![])])',
    'k': '"\\x6B"',
    'l': '((!!+[]+"")[(+!![])+(+!![])])',
    'm': '"\\x6D"',
    'n': '((+!![]/+[]+"")[+!![]])',
    'o': '((({})+"")[+!![]])',
    'p': '"\\x70"',
    'q': '"\\x71"',
    'r': '((!+[]+"")[+!![]])',
    's': '((!!+[]+"")[(+!![])+(+!![])+(+!![])])',
    't': '((!+[]+"")[+[]])',
    'u': '((!+[]+"")[(+!![])+(+!![])])',
    'v': '"\\x76"',
    'w': '"\\x77"',
    'x': "'x'",
    'y': '((+!![]/+[]+"")[(+!![])+(+!![])+(+!![])+(+!![])+(+!![])+(+!![])+(+!![])])',
    'z': '"\\x7A"',
    'A': '"\\x41"',
    'B': '"\\x42"',
    'C': '"\\x43"',
    'D': '"\\x44"',
    'E': '"\\x45"',
    'F': '"\\x46"',
    'G': '"\\x47"',
    'H': '"\\x48"',
    'I': '((+!![]/+[]+"")[+[]])',
    'J': '"\\x4A"',
    'K': '"\\x4B"',
    'L': '"\\x4C"',
    'M': '"\\x4D"',
    'N': '((+[]/+[]+"")[+[]])',
    'O': '((({})+"")[(+!![])+(+!![])+(+!![])+(+!![])+(+!![])+(+!![])+(+!![])+(+!![])])',
    'P': '"\\x50"',
    'Q': '"\\x51"',
    'R': '"\\x52"',
    'S': '"\\x53"',
    'T': '"\\x54"',
    'U': '"\\x55"',
    'V': '"\\x56"',
    'W': '"\\x57"',
    'X': '"\\x58"',
    'Y': '"\\x59"',
    'Z': '"\\x5A"',
    "(": "'('",
    ")": "')'",
    "{": "'{'",
    "}": "'}'",
    "[": "'['",
    "]": "']'",
    ".": "'.'",
    ";": "';'",
    "@": "'@'",
    "*": "'*'",
    '"': "'\"'",
    "/": "'/'",
    ":": "':'",
    ",": "','",
    "'": '"\'"',
    "=": "'='",
    ">": "'>'",
    "<": "'<'",
    "!": "'!'",
    "$": "'$'",
    "_": "'_'",
    "#": "'#'",
    "+": "'+'",
    "-": "'-'",
    "%": "'%'",
    " ": "' '",
    "?": "'?'",
    "|": "'|'",
    "^": "'^'",
    "&": "'&'",
    "~": "'~'",
    "`": "'`'",
    "\\": "'\\\\'",
    "0": "(+[])",
    "1": "(+!![])",
    "2": "((+!![])+(+!![]))",
    "3": "((+!![])+(+!![])+(+!![]))",
    "4": "((+!![])+(+!![])+(+!![])+(+!![]))",
    "5": "((+!![])+(+!![])+(+!![])+(+!![])+(+!![]))",
    "6": "((+!![])+(+!![])+(+!![])+(+!![])+(+!![])+(+!![]))",
    "7": "((+!![])+(+!![])+(+!![])+(+!![])+(+!![])+(+!![])+(+!![]))",
    "8": "((+!![])+(+!![])+(+!![])+(+!![])+(+!![])+(+!![])+(+!![])+(+!![]))",
    "9": "((+!![])+(+!![])+(+!![])+(+!![])+(+!![])+(+!![])+(+!![])+(+!![])+(+!![]))"
}


def absFilePaths(dir):
    for basename, dirs, files in os.walk(dir):
        for f in files:
            yield os.path.abspath(os.path.join(basename, f))


def convert_str(code, wrap=False):
    out = []
    minified = minify(code)

    for i in range(len(minified) - 1):
        out.append(symbols[minified[i]] + "+")  # All
    out.append(symbols[minified[-1]])           # Last char
    out = "".join(out)

    if wrap:
        out = "".join(["eval(", out, ");"])

    return out


def convert_file(script, rename=True):
    filename, extension = os.path.splitext(script)
    if extension != ".js":
        return False

    with open(script, "r") as in_script:
        src = in_script.read()
        out = convert_str(src, True)

    new_filename = "".join([filename, "-smug" if rename else "", extension])
    with open(new_filename, "w") as out_script:
        out_script.write(out)


def convert_dir(dir, rename=True):
    for filename in absFilePaths(dir):
        convert_file(filename, rename)


if __name__ == "__main__":
    if len(sys.argv) < 2:
        exit("No Input file...")

    source = sys.argv[1]
    if os.path.isfile(source):
        convert_file(source)
    elif os.path.isdir(source):
        convert_dir(source)
